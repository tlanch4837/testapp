<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuizForge — Modern UI (Clean Build)</title>
<style>
  :root{
    --bg1:#a78bfa;   /* violet-400 */
    --bg2:#60a5fa;   /* blue-400 */
    --card:#ffffffcc; /* glass */
    --text:#0f172a;  /* slate-900 */
    --muted:#475569; /* slate-600 */
    --ring:#22d3ee;  /* cyan-400 */
    --good:#16a34a;  /* green-600 */
    --bad:#dc2626;   /* red-600 */
    --btn1:#7c3aed;  /* violet-600 */
    --btn2:#06b6d4;  /* cyan-500 */
  }
  @media (prefers-color-scheme: dark){
    :root{
      --card:#0b1224cc; /* deep glass */
      --text:#f8fafc;   /* slate-50 */
      --muted:#94a3b8;  /* slate-400 */
      --btn1:#8b5cf6;
      --btn2:#22d3ee;
    }
    body{background:#0b1020;}
  }

  /* Background gradient */
  body{
    margin:0; min-height:100svh; color:var(--text);
    font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
    font-size:18px; line-height:1.4;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    background-attachment: fixed;
    display:flex; align-items:flex-start; justify-content:center;
  }
  .wrap{ width:min(1100px, 96vw); padding:24px; }

  /* Card (glass) */
  .card{ background:var(--card); backdrop-filter:saturate(140%) blur(12px);
    border:1px solid #ffffff40; border-radius:24px; padding:20px; box-shadow:0 20px 40px rgba(0,0,0,.15);
  }
  header.card{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }

  /* Inputs */
  input[type="file"], input[type="number"]{
    font-size:16px; color:var(--text); border:1px solid #ffffff70; background:#ffffffb3;
    border-radius:9999px; padding:10px 12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
  }
  input[type="number"]{ width:7rem; }
  label{ font-weight:700; }

  /* Buttons */
  .btn{
    appearance:none; border:0; border-radius:9999px; padding:12px 18px; font-weight:700; cursor:pointer;
    transition: transform .05s ease, box-shadow .2s ease, filter .2s ease; color:white; white-space:nowrap;
    box-shadow:0 10px 20px rgba(0,0,0,.15);
  }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; }
  .btn-primary{ background:linear-gradient(135deg, var(--btn1), var(--btn2)); }
  .btn-secondary{ background:linear-gradient(135deg, #64748b, #0ea5e9); }
  .btn-outline{ color:var(--text); background:transparent; border:2px solid #ffffff88; }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

  /* Quiz area */
  #quizPanel{ margin-top:12px; }
  #qCounter{ font-size:18px; font-weight:800; letter-spacing:.2px; }
  #timer{ font-weight:800; }
  .muted{ color:var(--muted); }

  .choices{ display:grid; gap:12px; grid-template-columns: 1fr; margin:14px 0; }
  @media (min-width:700px){ .choices{ grid-template-columns: 1fr 1fr; } }

  /* Custom radio pills */
  .choice{ position:relative; display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:16px;
    border:1px solid #ffffff7a; background:#ffffffcc; color:var(--text);
    box-shadow: 0 6px 14px rgba(0,0,0,.08);
    transition: box-shadow .25s ease, transform .05s ease, background .2s ease, border .2s ease;
  }
  .choice:hover{ box-shadow: 0 10px 22px rgba(0,0,0,.12); }
  .choice input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
  .choice span{ font-weight:700; }
  .choice.selected{ outline:3px solid var(--ring); outline-offset:2px; }

  .status{ margin-top:8px; min-height:1.4em; font-weight:700; }
  .ok{ color:var(--good); }
  .bad{ color:var(--bad); }

  /* Helper badges */
  .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:9999px; font-size:13px; font-weight:800;
    background:#ffffffcc; border:1px solid #ffffff7a; }

  /* Footer card */
  details summary{ cursor:pointer; }

  pre{ background:#00000020; padding:12px; border-radius:12px; overflow:auto; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <input type="file" id="fileInput" accept=".csv" />
      <div class="row">
        <label for="timeLimit">Time (min):</label>
        <input type="number" id="timeLimit" min="0" step="1" value="0" />
      </div>
      <button id="startBtn" class="btn btn-primary" disabled>Start</button>
      <button id="saveMissedBtn" class="btn btn-secondary" disabled>Save Missed</button>
      <button id="loadSampleBtn" class="btn btn-outline">Load Sample CSV</button>
      <span class="badge" title="Upload to enable controls">CSV • 5 columns</span>
    </header>

    <div class="card" id="quizPanel" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div><strong id="qCounter">Question 0/0</strong></div>
        <div><strong id="timer" class="muted">No timer</strong></div>
      </div>
      <div id="questionText" style="margin-top:10px; font-size:22px; font-weight:800;"></div>
      <div class="choices" id="choices"></div>
      <div class="row">
        <button id="submitBtn" class="btn btn-primary" disabled>Submit</button>
        <button id="nextBtn" class="btn btn-outline" disabled>Next</button>
      </div>
      <div class="status" id="feedback"></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <details>
        <summary><strong>CSV Format</strong></summary>
        <div class="muted" style="margin-top:8px;">
          Upload CSV with columns: <em>Question, Correct, Wrong1, Wrong2, Wrong3</em>.
        </div>
      </details>
    </div>

    <div class="card" style="margin-top:14px;">
      <details>
        <summary><strong>Self‑Tests</strong></summary>
        <div class="muted" style="margin:8px 0;">Run basic parser/escape tests to ensure no control‑char issues.</div>
        <div class="row">
          <button id="runTestsBtn" class="btn btn-outline">Run Tests</button>
          <button id="exportSampleMissedBtn" class="btn btn-outline">Export Sample Missed</button>
        </div>
        <pre id="testOut">(no tests run yet)</pre>
      </details>
    </div>
  </div>

<script>
(function() {
  // ---------- State ----------
  let bank = [];
  let deck = [];
  let order = [];
  let pos = 0;
  let selected = null;
  let timerId = null;
  let endTime = null;

  // ---------- Elements ----------
  const fileInput = document.getElementById('fileInput');
  const timeLimit = document.getElementById('timeLimit');
  const startBtn = document.getElementById('startBtn');
  const saveMissedBtn = document.getElementById('saveMissedBtn');
  const loadSampleBtn = document.getElementById('loadSampleBtn');
  const runTestsBtn = document.getElementById('runTestsBtn');
  const exportSampleMissedBtn = document.getElementById('exportSampleMissedBtn');
  const testOut = document.getElementById('testOut');
  const quizPanel = document.getElementById('quizPanel');
  const qCounter = document.getElementById('qCounter');
  const timerEl = document.getElementById('timer');
  const questionText = document.getElementById('questionText');
  const choicesEl = document.getElementById('choices');
  const submitBtn = document.getElementById('submitBtn');
  const nextBtn = document.getElementById('nextBtn');
  const feedback = document.getElementById('feedback');

  // ---------- Utils ----------
  function csvParse(text) {
    // RFC4180-ish parser (quotes, commas, CR/LF)
    const rows = [];
    let row = [];
    let cur = '';
    let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const n = text[i+1];
      if (inQuotes) {
        if (c === '"' && n === '"') { cur += '"'; i++; }
        else if (c === '"') { inQuotes = false; }
        else { cur += c; }
      } else {
        if (c === '"') inQuotes = true;
        else if (c === ',') { row.push(cur); cur = ''; }
        else if (c === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
        else if (c === '\r') { /* swallow CR; handle CRLF */ }
        else { cur += c; }
      }
    }
    if (cur !== '' || inQuotes || row.length) { row.push(cur); rows.push(row); }
    return rows.filter(r => r.some(cell => (cell ?? '').trim() !== ''));
  }

  function csvEscapeCell(s) {
    s = String(s ?? '');
    const needs = /[",\n\r]/.test(s);
    if (needs) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  }

  function downloadCSV(rows, filename) {
    // Use CRLF to maximize Excel compatibility
    const body = rows.map(r => r.map(csvEscapeCell).join(',')).join('\r\n') + '\r\n';
    const blob = new Blob([body], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function nowStamp() {
    const d = new Date(); const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
  }

  function shuffle(arr) { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  const setDisabled=(el, s)=> el.disabled=!!s;

  function resetRuntime() {
    deck = bank.map((q, idx) => ({ idx, question:q.question, correct:q.correct, wrongs:q.wrongs.slice(), status:'unsubmitted', userAnswer:null }));
    order = shuffle([...deck.keys()]); pos = 0; selected = null; clearFeedback();
    setDisabled(submitBtn, true); setDisabled(nextBtn, true); quizPanel.style.display = bank.length ? 'block' : 'none';
    render();
  }

  function markSelectedUI() {
    const nodes = choicesEl.querySelectorAll('.choice');
    nodes.forEach(n => n.classList.remove('selected'));
    const picked = [...nodes].find(n => n.dataset.value === String(selected));
    if (picked) picked.classList.add('selected');
  }

  function render() {
    if (!deck.length) return;
    const current = deck[ order[pos] ];
    qCounter.textContent = `Question ${pos+1}/${deck.length}`;
    questionText.textContent = current.question;

    choicesEl.innerHTML = '';
    const options = shuffle([ current.correct, ...current.wrongs ]);
    options.forEach((opt) => {
      const el = document.createElement('div');
      el.className = 'choice';
      el.dataset.value = opt;
      el.innerHTML = `<input type="radio" name="choice"><span>${opt}</span>`;
      el.addEventListener('click', () => {
        selected = opt; setDisabled(submitBtn, false); markSelectedUI();
      });
      choicesEl.appendChild(el);
    });

    const answered = current.status !== 'unsubmitted';
    setDisabled(submitBtn, answered);
    setDisabled(nextBtn, !answered);
    if (answered) {
      feedback.innerHTML = current.status === 'correct' ? `<span class="ok">Correct.</span>` : `<span class="bad">Incorrect.</span> Correct answer: <strong>${current.correct}</strong>`;
    } else { clearFeedback(); }
  }

  function clearFeedback(){ feedback.textContent=''; }
  function advance(){ if (pos < deck.length - 1){ pos++; selected=null; render(); } else { endQuiz(); } }
  function endQuiz(){ clearInterval(timerId); timerId=null; timerEl.textContent='Done'; setDisabled(nextBtn,true); setDisabled(submitBtn,true); }

  function tickTimer(){ if (!endTime) return; const remain=endTime-Date.now(); if(remain<=0){ timerEl.textContent='Time up'; timeUp(); return;} const secs=Math.ceil(remain/1000); const m=Math.floor(secs/60); const s=secs%60; timerEl.textContent=`${m}:${String(s).padStart(2,'0')}`; }
  function timeUp(){ clearInterval(timerId); timerId=null; setDisabled(submitBtn,true); setDisabled(nextBtn,true); endQuiz(); }

  // ---------- Events ----------
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; bank = []; setDisabled(startBtn,true); setDisabled(saveMissedBtn,true);
    if (!file){ quizPanel.style.display='none'; return; }
    const text = await file.text(); const rows = csvParse(text); const cleaned = [];
    for (const r of rows){ if (r.length < 5) continue; const [q, correct, w1, w2, w3] = r.map(c => (c ?? '').trim()); if (!q || !correct) continue; cleaned.push({ question:q, correct, wrongs:[w1, w2, w3] }); }
    bank = cleaned; setDisabled(startBtn, bank.length===0); setDisabled(saveMissedBtn, bank.length===0); quizPanel.style.display='none'; feedback.textContent='';
  });

  startBtn.addEventListener('click', () => {
    if (!bank.length) return; resetRuntime();
    const mins = parseInt(timeLimit.value, 10) || 0;
    if (mins > 0){ endTime = Date.now() + mins*60*1000; tickTimer(); timerId=setInterval(tickTimer, 250); }
    else { endTime=null; timerEl.textContent='No timer'; clearInterval(timerId); timerId=null; }
  });

  submitBtn.addEventListener('click', () => {
    const current = deck[ order[pos] ]; if (!current || selected == null) return;
    current.userAnswer = selected; current.status = (selected === current.correct) ? 'correct' : 'incorrect';
    feedback.innerHTML = current.status === 'correct' ? `<span class='ok'>Correct.</span>` : `<span class='bad'>Incorrect.</span> Correct answer: <strong>${current.correct}</strong>`;
    setDisabled(submitBtn,true); setDisabled(nextBtn,false);
  });

  nextBtn.addEventListener('click', advance);

  saveMissedBtn.addEventListener('click', () => {
    if (!bank.length) return;
    const source = deck.length ? deck : bank.map((q, idx) => ({ idx, ...q, status:'unsubmitted' }));
    const missed = source.filter(q => q.status !== 'correct');
    if (!missed.length){ const fnameEmpty = `quizforge_missed_${nowStamp()}.csv`; downloadCSV([], fnameEmpty); return; }
    const rows = missed.map(q => [ q.question, q.correct, q.wrongs?.[0] ?? '', q.wrongs?.[1] ?? '', q.wrongs?.[2] ?? '' ]);
    const fname = `quizforge_missed_${nowStamp()}.csv`; downloadCSV(rows, fname);
  });

  // ---------- Sample & Tests ----------
  loadSampleBtn?.addEventListener('click', () => {
    const sample = [
      'What color is the sky?,Blue,Red,Green,Yellow',
      'What is 2+2?,4,3,5,6',
      'Who wrote "Hamlet"?,William Shakespeare,Charles Dickens,Mark Twain,Jane Austen',
      'Pick the quoted, comma ", sample,Correct one,"Wrong, with, commas",Alt A,Alt B',
      'Multiline example,"Line1\\nLine2",A,B,C'
    ].join('\n');
    const rows = csvParse(sample);
    const cleaned = [];
    for (const r of rows){ if (r.length < 5) continue; const [q, correct, w1, w2, w3] = r.map(c => (c ?? '').trim()); if (!q || !correct) continue; cleaned.push({ question:q, correct, wrongs:[w1, w2, w3] }); }
    bank = cleaned; setDisabled(startBtn, bank.length===0); setDisabled(saveMissedBtn, bank.length===0); quizPanel.style.display='none'; feedback.textContent='';
    alert('Loaded sample quiz with ' + bank.length + ' items. Click Start.');
  });

  runTestsBtn?.addEventListener('click', () => {
    const logs = [];
    const assert = (name, cond) => logs.push((cond? '✅':'❌') + ' ' + name);

    // Test 1: parse simple
    const r1 = csvParse('Q1,A,B,C,D\nQ2,E,F,G,H');
    assert('Parse two simple rows', r1.length === 2 && r1[0][0] === 'Q1' && r1[1][1] === 'E');

    // Test 2: quoted commas
    const r2 = csvParse('"A, B",C,D,E,F');
    assert('Parse quoted comma cell', r2.length === 1 && r2[0][0] === 'A, B');

    // Test 3: escaped quote inside quoted field
    const r3 = csvParse('"He said ""hi""",A,B,C,D');
    assert('Parse escaped double quote', r3.length === 1 && r3[0][0] === 'He said "hi"');

    // Test 4: newline handling
    const r4 = csvParse('A,B,C,D,E\n');
    assert('Trailing newline handled', r4.length === 1 && r4[0].length === 5);

    // Test 5: csvEscapeCell quoting
    const e5 = csvEscapeCell('a,b\n"c"');
    assert('Escape needs quotes', /^".*"$/.test(e5) && e5.includes('""c""'));

    // Test 6: download body formatting (no control chars in source)
    const rows = [['Q','A','B','C','D']];
    const body = rows.map(r => r.map(csvEscapeCell).join(',')).join('\r\n') + '\r\n';
    assert('Body uses CRLF', body.endsWith('\r\n'));

    testOut.textContent = logs.join('\n');
  });

  exportSampleMissedBtn?.addEventListener('click', () => {
    const rows = [
      ['Sample question?','Correct','Wrong1','Wrong2','Wrong3'],
      ['Another?','Yes','No','Maybe','Later']
    ];
    downloadCSV(rows, 'quizforge_missed_' + nowStamp() + '.csv');
  });
})();
</script>
</body>
</html>
